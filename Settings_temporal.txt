// Settings.js (Esqueleto Inicial - Carga de Datos)
// ASEGÚRATE que supabase-init.js y auth-listener.js se cargaron antes

console.log('DEBUG: Settings.js - Cargado');

if (typeof supabase === 'undefined' || supabase === null) {
    console.error('Settings.js: ¡Error Crítico! Cliente Supabase no inicializado.');
    alert("Error crítico al cargar la configuración.");
    document.body.style.opacity = '0.5';
    document.body.style.pointerEvents = 'none';
} else {
    console.log('Settings.js: Cliente Supabase encontrado.');

    // --- Selección de Elementos DOM (Asegúrate que todos existen en Settings.html) ---
    const backButton = document.getElementById('backButton');
    const userAvatarSmall = document.getElementById('userAvatarSmall');
    const mainCurrencyEl = document.getElementById('mainCurrency');
    const defaultViewSetting = document.getElementById('defaultViewSetting');
    const defaultViewValueEl = document.getElementById('defaultViewValue');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const themeSelector = document.getElementById('themeSelector');
    const languageSetting = document.getElementById('languageSetting');
    const languageValueEl = document.getElementById('languageValue');
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const twoFactorToggle = document.getElementById('twoFactorToggle');
    const notifyFixedExpenseToggle = document.getElementById('notifyFixedExpenseToggle');
    const notifyBudgetAlertToggle = document.getElementById('notifyBudgetAlertToggle');
    const notifyGoalReachedToggle = document.getElementById('notifyGoalReachedToggle');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const helpLink = document.getElementById('helpLink');
    const privacyLink = document.getElementById('privacyLink');
    const termsLink = document.getElementById('termsLink');
    const appVersionEl = document.getElementById('appVersion');
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const pageContainer = document.querySelector('.page-container');
    const allToggles = document.querySelectorAll('.toggle-switch input[type="checkbox"]');
    const allButtons = document.querySelectorAll('.settings-grid button, .theme-option, #backButton, #editProfileBtn, #manageCategoriesBtn, #logoutBtn');


    // --- Variables de Estado ---
    let currentUserId = null;
    let currentUser = null;
    let userSettings = { // Valores por defecto iniciales
        theme: 'system', language: 'es', doble_factor_enabled: false,
        default_view: 'Dashboard', notify_fixed_expense: true,
        notify_budget_alert: true, notify_goal_reached: true,
        // Añade aquí más claves si tienes más columnas en 'profiles'
    };
    let isLoading = false;

    // --- Constantes ---
    const defaultAvatarPath = 'https://finai.es/images/avatar_predeterminado.png';

    // --- Funciones ---

    /** Muestra/Oculta un estado de carga visual */
    function setLoadingState(loading) {
        isLoading = loading;
        if (pageContainer) pageContainer.style.opacity = loading ? '0.5' : '1';
        allToggles.forEach(toggle => toggle.disabled = loading);
        allButtons.forEach(button => button.disabled = loading);
        console.log(`Loading state: ${loading ? 'ON' : 'OFF'}`);
    }

    /** Aplica el tema (clase al body) y actualiza botones del selector */
     function applyTheme(selectedTheme) {
        document.body.classList.remove('light-mode', 'dark-mode');
        console.log("Aplicando tema seleccionado:", selectedTheme);
        let effectiveTheme = selectedTheme;

        if (selectedTheme === 'system') {
             if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                 effectiveTheme = 'dark';
             } else {
                 effectiveTheme = 'light';
             }
             console.log(`Tema Sistema detectado como: ${effectiveTheme}`);
        }

        if (effectiveTheme === 'dark') {
             document.body.classList.add('dark-mode');
        } else {
             document.body.classList.add('light-mode');
        }

        if (themeSelector) {
            themeSelector.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === selectedTheme);
            });
        }
    }

    /** Carga las configuraciones del perfil del usuario desde Supabase */
    async function loadUserSettings() {
        if (!currentUserId) { console.error("Settings.js: No user ID."); return; }
        console.log("Cargando configuraciones para user:", currentUserId);
        setLoadingState(true);

        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                // ASEGÚRATE que estas columnas existen en tu tabla 'profiles'
                .select('theme, language, doble_factor_enabled, default_view, notify_fixed_expense, notify_budget_alert, notify_goal_reached, avatar_url')
                .eq('id', currentUserId)
                .single();

            if (error && error.code !== 'PGRST116') throw error;

            if (profile) {
                console.log("Perfil encontrado:", profile);
                userSettings.theme = profile.theme ?? 'system';
                userSettings.language = profile.language ?? 'es';
                userSettings.doble_factor_enabled = profile.doble_factor_enabled ?? false;
                userSettings.default_view = profile.default_view ?? 'Dashboard';
                // IMPORTANTE: Asegúrate que estas columnas booleanas existen o ajusta
                userSettings.notify_fixed_expense = profile.notify_fixed_expense ?? true;
                userSettings.notify_budget_alert = profile.notify_budget_alert ?? true;
                userSettings.notify_goal_reached = profile.notify_goal_reached ?? true;

                if(userAvatarSmall) userAvatarSmall.src = profile.avatar_url || defaultAvatarPath;
            } else {
                console.log("Perfil no encontrado, usando defaults en UI.");
                if(userAvatarSmall) userAvatarSmall.src = defaultAvatarPath;
            }
            updateUISettings();
        } catch (error) {
            console.error("Error cargando configuración:", error);
            alert(`Error al cargar la configuración: ${error.message}`);
            updateUISettings(); // Mostrar defaults si falla
        } finally {
            setLoadingState(false);
        }
    }

    /** Actualiza los controles de la UI con los valores del estado `userSettings` */
    function updateUISettings() {
        if (!document.body.contains(pageContainer)) return;
        console.log("Actualizando UI con settings:", userSettings);
        try {
            applyTheme(userSettings.theme); // Aplica tema y actualiza botones

            if(languageValueEl) { languageValueEl.textContent = userSettings.language === 'en' ? 'English ' : 'Español '; languageValueEl.insertAdjacentHTML('beforeend', '<i class="fas fa-chevron-right"></i>'); }
            if(twoFactorToggle) twoFactorToggle.checked = userSettings.doble_factor_enabled;
            if(notifyFixedExpenseToggle) notifyFixedExpenseToggle.checked = userSettings.notify_fixed_expense;
            if(notifyBudgetAlertToggle) notifyBudgetAlertToggle.checked = userSettings.notify_budget_alert;
            if(notifyGoalReachedToggle) notifyGoalReachedToggle.checked = userSettings.notify_goal_reached;
            if(defaultViewValueEl) { defaultViewValueEl.textContent = userSettings.default_view || 'Dashboard'; defaultViewValueEl.insertAdjacentHTML('beforeend', ' <i class="fas fa-chevron-right"></i>'); }
            if(mainCurrencyEl) mainCurrencyEl.textContent = 'EUR (Predet.)';
            if(appVersionEl) appVersionEl.textContent = 'FinAi v1.0.0'; // Considera hacerlo dinámico
        } catch (error) { console.error("Error actualizando UI:", error); }
    }

    /** Guarda una preferencia específica en la tabla profiles (Placeholder) */
    async function updateUserSetting(settingKey, settingValue) {
        // Esta función se completará en el siguiente paso
        console.warn(`GUARDADO PENDIENTE (Paso 2): ${settingKey} = ${settingValue}`);
         // Simulación optimista para UI:
         userSettings[settingKey] = settingValue;
         return Promise.resolve(); // Simular éxito
    }

    /** Maneja el borrado de cuenta (con múltiples confirmaciones - Placeholder) */
    async function handleDeleteAccount() {
        // Esta función se completará más adelante (Paso 7)
         if (!currentUserId || !currentUser) return;
         const confirm1 = prompt(`¡ACCIÓN IRREVERSIBLE!\nEsto eliminará PERMANENTEMENTE tu cuenta y TODOS tus datos.\n\nEscribe tu email (${currentUser?.email}) para confirmar:`);
         if (confirm1 !== currentUser?.email) { alert("Cancelado."); return; }
         const confirm2 = prompt(`SEGUNDA CONFIRMACIÓN:\nEscribe "ELIMINAR" para proceder:`);
         if (confirm2 !== "ELIMINAR") { alert("Cancelado."); return; }
         alert("Eliminación pendiente de implementación final en backend.");
         console.warn("Intento de eliminación de cuenta:", currentUserId);
     }

    // --- Asignación de Event Listeners ---
    document.addEventListener('authReady', (e) => {
        console.log('Settings.js: Received authReady event.');
        currentUser = e.detail.user;
        currentUserId = currentUser?.id;
        if(currentUserId) { loadUserSettings(); }
        else { console.warn("Settings.js: No user."); if(pageContainer) pageContainer.innerHTML = '<p style="color:orange; text-align:center;">Debes iniciar sesión.</p>'; }
    });

    document.addEventListener('DOMContentLoaded', () => {
        console.log("Settings.js: DOM fully loaded.");
        // Listener para botón Volver
        if (backButton) backButton.addEventListener('click', () => { window.location.href = '/Dashboard.html'; });
        // Listener para Scroll-to-top
        if (scrollTopBtn) { window.addEventListener('scroll', () => { scrollTopBtn.classList.toggle('visible', window.scrollY > 300); }); scrollTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }); }

        // --- LISTENERS PARA FUNCIONALIDAD (Se añadirán en pasos siguientes) ---
        // if (themeSelector) { themeSelector.addEventListener('click', ...); }
        // if (logoutBtn) { logoutBtn.addEventListener('click', ...); }
        // if (twoFactorToggle) { twoFactorToggle.addEventListener('change', ...); }
        // etc.

    }); // Fin DOMContentLoaded

} // Fin check Supabase



AUTH-LISTENER.JS


// auth-listener.js (v7 - Corrected SIGNED_IN Logic)
console.log('DEBUG: auth-listener.js - Cargado (v7)');

if (typeof supabase !== 'undefined' && supabase !== null) {
    console.log('auth-listener.js: Supabase client encontrado. Adjuntando listener.');
    let initialAuthCheckDone = false;

    async function getDefaultView(userId) {
        const fallbackPage = '/Dashboard.html'; // Página por defecto si falla la carga
        if (!userId) return fallbackPage;

        try {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('default_view')
                .eq('id', userId)
                .maybeSingle();

            if (error && error.code !== 'PGRST116') {
                console.error("Auth-Listener: Error fetching default_view", error);
                return fallbackPage; // Usar fallback si hay error
            }

            const view = profile?.default_view || 'Dashboard'; // Usar Dashboard si es null en DB
            // Asegurarse que la vista tiene formato de ruta .html
            // Esto asume que los valores guardados son 'Dashboard', 'Accounts', etc.
            const pageName = `/${view}.html`;
            console.log(`Auth-Listener: Default view found for user ${userId}: ${pageName}`);
            // Podríamos añadir una verificación extra aquí para asegurar que pageName es una ruta válida en tu app
            const validPages = ['/Dashboard.html', '/Accounts.html', '/Categories.html', '/Transactions.html', '/Budgets.html', '/Goals.html', '/Fixed_expenses.html', '/Debts.html', '/Loans.html', '/Trips.html', '/Settings.html', '/Profile.html']; // Añade todas tus páginas válidas
            if (validPages.includes(pageName)) {
                return pageName;
            } else {
                console.warn(`Auth-Listener: Default view "${view}" resultó en página inválida "${pageName}". Usando fallback.`);
                return fallbackPage; // Usar fallback si el nombre no es válido
            }
            return pageName;

        } catch (e) {
            console.error("Auth-Listener: Exception fetching default_view", e);
            return fallbackPage; // Usar fallback en caso de excepción
        }
    }

    supabase.auth.onAuthStateChange(async (event, session) => {
        const currentPath = window.location.pathname;
        const user = session?.user;

        // Log inicial
        console.log(`\n--- Auth State Change (v7) ---`);
        console.log(`  Path: [${currentPath}]`);
        console.log(`  Event: ${event}`);
        console.log(`  User: ${user ? user.id : 'null'}`);
        console.log(`  Session: ${session ? '[Exists]' : 'null'}`);
        console.log(`----------------------------`);

        // Nombres de páginas
        const loginPageName = '/Login.html';
        const dashboardPageName = '/Dashboard.html';
        const resetPasswordPageName = '/Reset_password.html';
        const forgotPasswordPageName = '/Reset_password_email.html';
        // No necesitamos listar todas las páginas protegidas aquí

        // Disparar 'authReady' una sola vez
        if (!initialAuthCheckDone) {
             initialAuthCheckDone = true;
             console.log('DEBUG (v7): Triggering authReady.');
             document.dispatchEvent(new CustomEvent('authReady', { detail: { session, user } }));
        }

        // --- Salida Temprana para Reset Page ---
        if (currentPath.endsWith(resetPasswordPageName)) {
            console.log('DEBUG (v7): En Reset Password Page. DETENIENDO listener.');
            return;
        }

        // --- MANEJO DE EVENTOS ESPECÍFICOS ---

        // Evento: Recuperación de contraseña (lleva a la página de reset si no estás ahí)
        if (event === 'PASSWORD_RECOVERY') {
            console.log("DEBUG (v7): Evento PASSWORD_RECOVERY.");
            if (!currentPath.endsWith(resetPasswordPageName)) {
                console.log('DEBUG (v7): Redirigiendo desde RECOVERY a:', resetPasswordPageName);
                window.location.replace(resetPasswordPageName);
            }
            return; // Detener aquí
        }

        // Evento: Cierre de sesión (SIEMPRE lleva a login si no estás ahí)
        if (event === 'SIGNED_OUT') {
            console.log("DEBUG (v7): Evento SIGNED_OUT.");
            if (!currentPath.endsWith(loginPageName)) {
                console.log(`DEBUG (v7): SIGNED_OUT - Redirigiendo a login (${loginPageName}).`);
                window.location.replace(loginPageName);
            } else {
                console.log('DEBUG (v7): SIGNED_OUT - Ya en login, no redirigir.');
            }
            return; // Detener aquí
        }

        // Evento: Inicio de sesión (Solo redirige a Dashboard SI estás en Login)
        if (event === 'SIGNED_IN') {
            console.log("DEBUG (v8): Evento SIGNED_IN detectado.");
            if (user) {
                // Acaba de iniciar sesión o confirmar email -> obtener default view y redirigir
                const targetPage = await getDefaultView(user.id);
                console.log(`DEBUG (v8): SIGNED_IN - Redirigiendo a default view: ${targetPage}`);
                // Solo redirigir si NO estamos ya en la página destino (evita bucle si default es /)
                if (window.location.pathname !== targetPage.substring(targetPage.lastIndexOf('/'))) {
                     window.location.replace(targetPage);
                } else {
                    console.log(`DEBUG (v8): SIGNED_IN - Ya en la página destino (${targetPage}). No se redirige.`);
                }
            } else {
                 console.warn("DEBUG (v8): SIGNED_IN sin usuario? Redirigiendo a Login.");
                 if (!currentPath.endsWith(loginPageName)) window.location.replace(loginPageName);
            }
            return; // Detener aquí
        }

        // --- LÓGICA GENERAL (Para INITIAL_SESSION o eventos desconocidos) ---
        console.log("DEBUG (v7): Ejecutando Lógica General (probablemente INITIAL_SESSION).");
        console.log(`DEBUG (v7): General Logic Check - User: ${!!user}, Path: [${currentPath}]`);

        if (user) { // Usuario logueado (y no fue un evento específico manejado arriba)
            console.log("DEBUG (v7): User is LOGGED IN (Initial Session?).");
             // ¿Está en una página pública donde NO debería estar? (Login/Forgot)
             if (currentPath.endsWith(loginPageName) || currentPath.endsWith(forgotPasswordPageName)) {
                console.log(`DEBUG (v7): Logged in on Public Auth Page (${currentPath}). REDIRECTING to Dashboard.`);
                if (window.location.pathname !== targetPage.substring(targetPage.lastIndexOf('/'))) {
                    window.location.replace(targetPage);
                 } else {
                     console.log(`DEBUG (v8): Initial Session - Ya en la página destino (${targetPage}). No se redirige.`);
                 }
            } else {
                 // Está en una página protegida (Dashboard, Settings, Profile, etc.) o en Reset. ¡Todo OK!
                 console.log(`DEBUG (v7): Logged in on Page [${currentPath}]. Acceso permitido.`);
            }
        } else { // Usuario NO logueado
             console.log("DEBUG (v7): User is LOGGED OUT (Initial Session?).");
             // ¿Está en una página pública permitida?
             const publicPageNames = [loginPageName, forgotPasswordPageName, resetPasswordPageName];
             let isPublic = publicPageNames.some(pageName => currentPath.endsWith(pageName)) || currentPath === '/' || currentPath.endsWith('/index.html');

             if (!isPublic) {
                 // NO está en pública y NO está logueado -> A Login!
                 console.warn(`DEBUG (v7): Logged out on PROTECTED Page (${currentPath}). REDIRECTING to Login.`);
                  window.location.replace(loginPageName); // Redirección de protección ACTIVADA
             } else {
                  console.log(`DEBUG (v7): Logged out on PUBLIC Page (${currentPath}). No redirect needed.`);
             }
        }
        console.log("DEBUG (v7): End of listener execution.");
    });

} else {
    console.error("auth-listener.js (v7): Supabase client no está definido.");
}